# Project Knowledge Base

This file captures knowledge learned during development sessions. Updated continuously.

---

## Session: 2026-02-09

### Refund Detection Feature (Completed)

**Problem Solved**: Bank payments matching customer names (not suppliers) were being skipped without explanation. Similarly for receipts matching suppliers.

**Solution Implemented**:
- `_check_customer_refund()` in `bank_import.py` (line 958) - queries stran for unallocated credit notes (st_trtype IN ('C', 'R'), st_trbal < 0)
- `_check_purchase_refund()` in `bank_import.py` (line 989) - queries ptran for unallocated credit notes (pt_trtype='C', pt_trbal > 0)
- If credit note found → action = 'sales_refund' or 'purchase_refund'
- If no credit note → skip with reason "Payment matches customer X but no unallocated credit note found"

**Transaction Types**:
| at_type | Description | atran.at_value | Bank Effect |
|---------|-------------|----------------|-------------|
| 1 | Sales Receipt | +amount (pence) | Increases |
| 2 | Purchase Payment | -amount (pence) | Decreases |
| 3 | Sales Refund | -amount (pence) | Decreases |
| 6 | Purchase Refund | +amount (pence) | Increases |

**Import Methods**:
- `import_sales_refund()` at `opera_sql_import.py:1732`
- `import_purchase_refund()` at `opera_sql_import.py:2636`

**Frontend**: Tabbed preview UI in `Imports.tsx` with:
- Checkboxes on ALL tabs (Receipts, Payments, Refunds, Unmatched, Skipped)
- Transaction type dropdown (4 options)
- Accept/Reject buttons for auto-detected refunds
- Select All / Deselect All per tab

---

## Historical Knowledge

### Opera Database Conventions

**Amount Storage** (CRITICAL):
- `aentry`/`atran` tables: amounts in **PENCE** (multiply by 100)
- `ntran`/`ptran`/`stran` tables: amounts in **POUNDS**

**Payment Signs in atran**:
- Payments = NEGATIVE values
- Receipts = POSITIVE values

**nt_trnref Format** (Nominal Ledger):
- First 30 characters contain Supplier/Customer name
- Used for matching NL entries to PL/SL

### Control Accounts

Control account codes vary by installation. Retrieved dynamically:
- **Primary**: `sprfls` table (`sc_dbtctrl` for debtors, `pc_crdctrl` for creditors)
- **Fallback**: `nparm` table (`np_dca` for debtors, `np_cca` for creditors)
- **Helper**: `sql_rag/opera_config.py` → `get_control_accounts()`

### Unique ID Generation

Format: `_XXXXXXXXX` (underscore + 9 base-36 characters)
- Used for: `ae_unique`, `at_unique`, `nt_unique`, `pt_unique`, `st_unique`
- Generated by: `OperaSQLImport.generate_unique_id()`

### Transfer Files (anoml, pnoml, snoml)

These are "posting queues" for nominal ledger updates:
- `anoml` - Cashbook → Nominal (ax_done='Y' when posted)
- `pnoml` - Purchase Ledger → Nominal (px_done='Y' when posted)
- `snoml` - Sales Ledger → Nominal (sx_done='Y' when posted)

### Balance Updates Required

When posting to **ntran** (Nominal Ledger), MUST also update **nacnt**:
- `na_ptddr/na_ptdcr` - Period to date debit/credit
- `na_ytddr/na_ytdcr` - Year to date debit/credit
- `na_balc{period}` - Period balance (na_balc01 for Jan, etc.)

When posting **Cashbook**, MUST also update **nbank**:
- `nk_curbal` - Bank current balance (in pence)

### Data Sources

| Source | Type | Location | Reader |
|--------|------|----------|--------|
| Opera SQL SE | SQL Server | Network DB | pyodbc |
| Opera 3 | FoxPro DBF | `C:\Apps\O3 Server VFP` | `opera3_foxpro.py` |

### File Locations

| Purpose | File |
|---------|------|
| Bank import (SQL SE) | `sql_rag/bank_import.py` |
| Bank import (Opera 3) | `sql_rag/bank_import_opera3.py` |
| Opera posting (SQL SE) | `sql_rag/opera_sql_import.py` |
| Opera 3 FoxPro reader | `sql_rag/opera3_foxpro.py` |
| API endpoints | `api/main.py` |
| Frontend imports page | `frontend/src/pages/Imports.tsx` |
| Opera config loader | `sql_rag/opera_config.py` |

### API Ports

- Backend API: `http://localhost:8000`
- Frontend dev: `http://localhost:5173`

### Never Do

1. **Never modify Opera database structure** (tables, columns, indexes)
2. **Never write to Opera without explicit user request**
3. **Never hold long transactions** (causes locking issues for other users)
4. **Never skip balance updates** (causes control account mismatches)

---

## Bank Statement Selection Rules (CRITICAL)

**A statement is only valid for import if ALL of these conditions are met:**

1. **Account Match**: Statement sort code AND account number must match the selected Opera bank (from `nbank.nk_sort` and `nbank.nk_number`)
2. **Balance Match**: Statement opening balance must equal Opera's reconciled balance (`nbank.nk_recbal / 100.0`) within £0.01 tolerance
3. **Sequential Import**: Statements must be imported in order - opening balance of next statement should match closing balance of previous

**Why this matters:**
- This is a FINANCE system - numbers must be accurate
- Prevents importing wrong statements for wrong accounts
- Ensures continuous reconciliation trail
- Statements with opening < reconciled are auto-marked as already processed

**Implementation in `api/main.py` scan-emails endpoint:**
- Fetches `nk_sort`, `nk_number`, `nk_recbal` for selected bank code
- Extracts sort/account/opening balance from PDF via AI
- Compares normalized values (strips spaces, dashes)
- Rejects mismatched statements before showing in UI

---

## Troubleshooting

### "Payment matches customer but no unallocated credit note found"
- **Cause**: Payment name matched a customer, but stran has no credit notes with st_trbal < 0
- **Resolution**: Either allocate manually in Opera, or override transaction type in UI

### Refund Detection Not Working
- **Common Cause**: Memo field not properly formatted with tab separator
- **Barclays Format**: `NAME\tREFERENCE` (tab between name and reference)
- **Example**: `RBK\tREFUND FT` → Name extracts as "RBK"
- **Without Tab**: `RBK REFUND FT` → Match score too low (0.53 < 0.6 threshold)

### Duplicate Detection
- Uses pattern: `ABS(ABS(at_value) - amount)` to match within tolerance
- Checks date range: post_date ± 7 days

---

## Testing Notes

### Verified Working (2026-02-09)

**Refund Detection Test**:
- Test file: `/Users/maccb/Downloads/test_refund.csv`
- Payment: £615.00 to RBK (with tab in memo)
- Result: Correctly detected as `sales_refund`
- Found credit note: INTSYSUKLTD-RCXYCQ (£615.00 unallocated)

**Refund Import Test** (Successful):
- atran entry created: P100008045, -£615.00, at_type=3 (Sales Refund)
- stran entry created: Type F (Refund), +£615.00
- Credit note NOT auto-allocated (correct - allocation done separately in Opera)
- Duplicate detection correctly flags as "already posted" on subsequent previews

**Purchase Refund Detection Test** (2026-02-09):
- Test file: `/Users/maccb/Downloads/test_purchase_refund.csv`
- Receipt: £500.00 from AMAZON (supplier)
- No unallocated credit notes in ptran for any supplier
- Correctly skipped with reason: "Receipt matches supplier Amazon.co.uk but no unallocated credit note found"
- `_check_purchase_refund()` queries: `pt_trtype IN ('C', 'P') AND pt_trbal > 0`

---

*Last updated: 2026-02-15*
